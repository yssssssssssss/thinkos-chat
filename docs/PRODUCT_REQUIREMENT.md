# ThinkOS Chat - Agentã€MCPã€Skills èƒ½åŠ›å®æ–½è®¡åˆ’

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜å¦‚ä½•åœ¨ ThinkOS Chat é¡¹ç›®ä¸­æ·»åŠ å’Œæ‰©å±• Agentã€MCPã€Skills ä¸‰å±‚æ¶æ„èƒ½åŠ›ã€‚

### æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      UI å±‚ (ChatView)                    â”‚
â”‚  ç”¨æˆ·äº¤äº’ç•Œé¢ï¼šè¾“å…¥æ¡†ã€æŒ‰é’®ã€å¯¹è¯æ¡†                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Agent å±‚ (æ™ºèƒ½ä»£ç†)                      â”‚
â”‚  - æ„å›¾è¯†åˆ«ï¼šç†è§£ç”¨æˆ·è‡ªç„¶è¯­è¨€                              â”‚
â”‚  - æŠ€èƒ½è°ƒåº¦ï¼šé€‰æ‹©åˆé€‚çš„ Skill æ‰§è¡Œä»»åŠ¡                      â”‚
â”‚  - å‚æ•°æå–ï¼šä»ç”¨æˆ·è¾“å…¥ä¸­æå–æ‰§è¡Œå‚æ•°                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               MCP å±‚ (Model Context Protocol)            â”‚
â”‚  - æŠ€èƒ½æ³¨å†Œï¼šç®¡ç†æ‰€æœ‰å¯ç”¨æŠ€èƒ½                              â”‚
â”‚  - åè®®å®šä¹‰ï¼šç»Ÿä¸€çš„æ¥å£å’Œæ•°æ®æ ¼å¼                          â”‚
â”‚  - ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼šæŠ€èƒ½çš„æ³¨å†Œã€æŸ¥è¯¢ã€æ‰§è¡Œ                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Skills å±‚ (æŠ€èƒ½å®ç°)                     â”‚
â”‚  - å›¾ç‰‡å¤„ç†ï¼šæ‰©å±•ã€è£å‰ªã€ç¼©æ”¾ã€æ»¤é•œç­‰                       â”‚
â”‚  - æ–‡æœ¬å¤„ç†ï¼šç¿»è¯‘ã€æ‘˜è¦ã€æ ¼å¼åŒ–ç­‰                          â”‚
â”‚  - æ•°æ®å¤„ç†ï¼šå¯¼å‡ºã€è½¬æ¢ã€åˆ†æç­‰                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ ä»¥"å›¾ç‰‡æ‰©å±•"ä¸ºä¾‹çš„å®Œæ•´å®æ–½æµç¨‹

### ç¬¬ä¸€æ­¥ï¼šå®šä¹‰ Skill èƒ½åŠ›ï¼ˆSkills å±‚ï¼‰

#### 1.1 åˆ›å»º Skill ç±»å‹å®šä¹‰

**æ–‡ä»¶ä½ç½®**: `src/skills/base/types.ts`

```typescript
// å®šä¹‰ Skill çš„åŸºç¡€æ¥å£
export interface SkillManifest {
  id: string;                  // å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œå¦‚ 'image-expand'
  name: string;                // æ˜¾ç¤ºåç§°ï¼Œå¦‚ 'å›¾ç‰‡å°ºå¯¸æ‰©å±•'
  description: string;         // åŠŸèƒ½æè¿°
  version: string;             // ç‰ˆæœ¬å·
  parameters: ParameterSchema; // å‚æ•°å®šä¹‰
}

// å®šä¹‰å‚æ•°çš„ç»“æ„
export interface ParameterSchema {
  type: 'object';
  properties: Record<string, PropertySchema>;
  required?: string[];
}

// å®šä¹‰å…·ä½“çš„å‚æ•°å±æ€§
export interface PropertySchema {
  type: string;        // 'string' | 'number' | 'boolean' | 'array'
  description: string; // å‚æ•°è¯´æ˜
  default?: any;       // é»˜è®¤å€¼
  enum?: string[];     // æšä¸¾å€¼
}

// å®šä¹‰æ‰§è¡Œç»“æœ
export interface SkillResult {
  success: boolean;
  data?: any;
  error?: string;
}

// Skill æ¥å£
export interface Skill {
  manifest: SkillManifest;
  execute(params: Record<string, any>): Promise<SkillResult>;
  validate(params: Record<string, any>): { valid: boolean; errors: string[] };
}
```

#### 1.2 åˆ›å»º BaseSkill åŸºç±»

**æ–‡ä»¶ä½ç½®**: `src/skills/base/skill.ts`

```typescript
import { Skill, SkillManifest, SkillResult } from './types';

export abstract class BaseSkill implements Skill {
  // å­ç±»å¿…é¡»å®ç° manifest
  abstract manifest: SkillManifest;

  // å­ç±»å¿…é¡»å®ç° execute
  abstract execute(params: Record<string, any>): Promise<SkillResult>;

  // å‚æ•°éªŒè¯ï¼ˆè‡ªåŠ¨å®Œæˆï¼Œå­ç±»å¯è¦†ç›–ï¼‰
  validate(params: Record<string, any>): { valid: boolean; errors: string[] } {
    const errors: string[] = [];
    const { required = [] } = this.manifest.parameters;

    // æ£€æŸ¥å¿…éœ€å‚æ•°
    for (const key of required) {
      if (!(key in params) || params[key] === undefined || params[key] === null) {
        errors.push(`ç¼ºå°‘å¿…è¦å‚æ•°: ${key}`);
      }
    }

    // æ£€æŸ¥å‚æ•°ç±»å‹
    const { properties } = this.manifest.parameters;
    for (const [key, value] of Object.entries(params)) {
      const schema = properties[key];
      if (schema && !this.validateType(value, schema.type)) {
        errors.push(`å‚æ•° "${key}" ç±»å‹é”™è¯¯`);
      }
    }

    return { valid: errors.length === 0, errors };
  }

  private validateType(value: any, expectedType: string): boolean {
    const actualType = Array.isArray(value) ? 'array' : typeof value;
    return actualType === expectedType;
  }

  // ä¾¿æ·æ–¹æ³•
  protected createSuccessResult(data?: any): SkillResult {
    return { success: true, data };
  }

  protected createErrorResult(error: string): SkillResult {
    return { success: false, error };
  }
}
```

#### 1.3 å®ç°å…·ä½“çš„ Skill

**æ–‡ä»¶ä½ç½®**: `src/skills/image/expandImage.ts`

```typescript
import { BaseSkill } from '../base/skill';
import { ExpandImageParams, ExpandImageResult } from '../base/types';

export class ExpandImageSkill extends BaseSkill {
  // å®šä¹‰ Skill çš„ manifest
  manifest = {
    id: 'image-expand',
    name: 'å›¾ç‰‡å°ºå¯¸æ‰©å±•',
    description: 'å°†å›¾ç‰‡æ‰©å±•åˆ°æŒ‡å®šå°ºå¯¸ï¼Œæ”¯æŒå¤šç§å¡«å……æ¨¡å¼',
    version: '1.0.0',
    parameters: {
      type: 'object' as const,
      properties: {
        imageUrl: {
          type: 'string',
          description: 'å›¾ç‰‡ URL æˆ– Base64 ç¼–ç '
        },
        targetWidth: {
          type: 'number',
          description: 'ç›®æ ‡å®½åº¦ (åƒç´ )'
        },
        targetHeight: {
          type: 'number',
          description: 'ç›®æ ‡é«˜åº¦ (åƒç´ )'
        },
        mode: {
          type: 'string',
          description: 'å¡«å……æ¨¡å¼: fill(å¡«æ»¡) | fit(é€‚åº”) | stretch(æ‹‰ä¼¸)',
          default: 'fill'
        },
        backgroundColor: {
          type: 'string',
          description: 'èƒŒæ™¯è‰² (CSS é¢œè‰²å€¼)',
          default: '#ffffff'
        }
      },
      required: ['imageUrl', 'targetWidth', 'targetHeight']
    }
  };

  // å®ç° execute æ–¹æ³•
  async execute(params: ExpandImageParams): Promise<SkillResult> {
    try {
      // 1. å‚æ•°æå–
      const { imageUrl, targetWidth, targetHeight, mode = 'fill', backgroundColor = '#ffffff' } = params;

      // 2. å‚æ•°éªŒè¯
      if (targetWidth <= 0 || targetHeight <= 0) {
        return this.createErrorResult('ç›®æ ‡å°ºå¯¸å¿…é¡»å¤§äº 0');
      }

      // 3. åŠ è½½å›¾ç‰‡
      const img = await this.loadImage(imageUrl);

      // 4. åˆ›å»º Canvas å¹¶å¤„ç†
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d')!;
      canvas.width = targetWidth;
      canvas.height = targetHeight;

      // 5. å¡«å……èƒŒæ™¯
      ctx.fillStyle = backgroundColor;
      ctx.fillRect(0, 0, targetWidth, targetHeight);

      // 6. è®¡ç®—ç»˜åˆ¶å¸ƒå±€
      const layout = this.calculateLayout(
        img.width, img.height,
        targetWidth, targetHeight,
        mode
      );

      // 7. ç»˜åˆ¶å›¾ç‰‡
      ctx.drawImage(img, layout.sx, layout.sy, layout.sWidth, layout.sHeight,
                         layout.dx, layout.dy, layout.dWidth, layout.dHeight);

      // 8. å¯¼å‡ºç»“æœ
      const resultUrl = canvas.toDataURL('image/png');

      return this.createSuccessResult({
        imageUrl: resultUrl,
        originalWidth: img.width,
        originalHeight: img.height,
        targetWidth,
        targetHeight,
        mode
      });
    } catch (error) {
      return this.createErrorResult(error instanceof Error ? error.message : 'å¤„ç†å¤±è´¥');
    }
  }

  // è¾…åŠ©æ–¹æ³•
  private loadImage(src: string): Promise<HTMLImageElement> {
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.crossOrigin = 'anonymous';
      img.onload = () => resolve(img);
      img.onerror = () => reject(new Error('å›¾ç‰‡åŠ è½½å¤±è´¥'));
      img.src = src;
    });
  }

  private calculateLayout(srcW: number, srcH: number, dstW: number, dstH: number, mode: string) {
    // ... å¸ƒå±€è®¡ç®—é€»è¾‘
  }
}
```

---

### ç¬¬äºŒæ­¥ï¼šæ³¨å†Œ Skillï¼ˆMCP å±‚ï¼‰

#### 2.1 åˆ›å»º Skill æ³¨å†Œè¡¨

**æ–‡ä»¶ä½ç½®**: `src/mcp/registry.ts`

```typescript
import { Skill } from '../skills/base/types';

class SkillRegistry {
  private skills = new Map<string, Skill>();

  // æ³¨å†Œ Skill
  register(skill: Skill): void {
    const { id } = skill.manifest;
    this.skills.set(id, skill);
    console.log(`âœ… Skill æ³¨å†ŒæˆåŠŸ: ${id}`);
  }

  // è·å– Skill
  get(id: string): Skill | undefined {
    return this.skills.get(id);
  }

  // è·å–æ‰€æœ‰ Skills
  getAll(): Skill[] {
    return Array.from(this.skills.values());
  }

  // æ ¹æ®åˆ†ç±»æŸ¥æ‰¾
  findByCategory(category: string): Skill[] {
    return this.getAll().filter(skill =>
      skill.manifest.id.startsWith(`${category}-`)
    );
  }
}

// å¯¼å‡ºå•ä¾‹
export const skillRegistry = new SkillRegistry();
```

#### 2.2 ç»Ÿä¸€æ³¨å†Œæ‰€æœ‰ Skills

**æ–‡ä»¶ä½ç½®**: `src/skills/index.ts`

```typescript
import { skillRegistry } from '../mcp/registry';
import { ExpandImageSkill } from './image/expandImage';

export function registerSkills(): void {
  // æ³¨å†Œå›¾ç‰‡å¤„ç† Skills
  skillRegistry.register(new ExpandImageSkill());

  // æ³¨å†Œå…¶ä»– Skills
  // skillRegistry.register(new CropImageSkill());
  // skillRegistry.register(new ResizeImageSkill());
}

export function getRegisteredSkills() {
  return skillRegistry.getAll();
}
```

---

### ç¬¬ä¸‰æ­¥ï¼šå®ç° Agent æ™ºèƒ½è°ƒåº¦ï¼ˆAgent å±‚ï¼‰

#### 3.1 åˆ›å»ºæ„å›¾è¯†åˆ«å™¨

**æ–‡ä»¶ä½ç½®**: `src/agent/intentRecognizer.ts`

```typescript
import { Intent } from './types';

// æŠ€èƒ½åŒ¹é…æ¨¡å¼
const SKILL_PATTERNS: Record<string, RegExp[]> = {
  'image-expand': [
    /æ‰©å±•.*å°ºå¯¸/i,
    /è°ƒæ•´.*å¤§å°/i,
    /æ”¹æˆ.*å°ºå¯¸/i,
    /æ”¾å¤§.*å›¾ç‰‡/i,
  ],
};

// å‚æ•°æå–æ­£åˆ™
const PARAM_PATTERNS = {
  widthHeight: /(\d+)\s*[xÃ—]\s*(\d+)/,
  preset: /(HD|FHD|4K|Instagram)/i,
  mode: /(å¡«å……|é€‚åº”|æ‹‰ä¼¸|fill|fit|stretch)/i,
};

// é¢„è®¾å°ºå¯¸æ˜ å°„
const PRESET_SIZES: Record<string, { width: number; height: number }> = {
  'HD': { width: 1280, height: 720 },
  'FHD': { width: 1920, height: 1080 },
  '4K': { width: 3840, height: 2160 },
};

export class IntentRecognizer {
  // è¯†åˆ«ç”¨æˆ·æ„å›¾
  recognize(input: string): Intent {
    // 1. æ¨¡å¼åŒ¹é…
    for (const [skillId, patterns] of Object.entries(SKILL_PATTERNS)) {
      for (const pattern of patterns) {
        if (pattern.test(input)) {
          return {
            type: 'image-processing',
            skillId,
            parameters: this.extractParameters(input, skillId),
            confidence: 0.9
          };
        }
      }
    }

    // 2. æœªåŒ¹é…åˆ°
    return {
      type: 'unknown',
      parameters: {},
      confidence: 0
    };
  }

  // æå–å‚æ•°
  private extractParameters(input: string, skillId: string): Record<string, any> {
    const params: Record<string, any> = {};

    // æå–å°ºå¯¸ (1920x1080)
    const sizeMatch = input.match(PARAM_PATTERNS.widthHeight);
    if (sizeMatch) {
      params.targetWidth = parseInt(sizeMatch[1]);
      params.targetHeight = parseInt(sizeMatch[2]);
    }

    // æå–é¢„è®¾å°ºå¯¸
    const presetMatch = input.match(PARAM_PATTERNS.preset);
    if (presetMatch) {
      const preset = PRESET_SIZES[presetMatch[1].toUpperCase()];
      if (preset) {
        params.targetWidth = preset.width;
        params.targetHeight = preset.height;
      }
    }

    // æå–æ¨¡å¼
    const modeMatch = input.match(PARAM_PATTERNS.mode);
    if (modeMatch) {
      const modeMap: Record<string, string> = {
        'å¡«å……': 'fill',
        'é€‚åº”': 'fit',
        'æ‹‰ä¼¸': 'stretch'
      };
      params.mode = modeMap[modeMatch[1]] || modeMatch[1].toLowerCase();
    }

    return params;
  }
}
```

#### 3.2 åˆ›å»º Agent æ ¸å¿ƒ

**æ–‡ä»¶ä½ç½®**: `src/agent/agent.ts`

```typescript
import { IntentRecognizer } from './intentRecognizer';
import { Intent, AgentResponse } from './types';
import { skillRegistry } from '../mcp/registry';

export class Agent {
  private recognizer: IntentRecognizer;

  constructor() {
    this.recognizer = new IntentRecognizer();
  }

  // å¤„ç†ç”¨æˆ·è¾“å…¥
  async chat(input: string): Promise<AgentResponse> {
    // 1. æ„å›¾è¯†åˆ«
    const intent = this.recognizer.recognize(input);

    // 2. æ£€æŸ¥æ˜¯å¦è¯†åˆ«åˆ°æœ‰æ•ˆæ„å›¾
    if (!intent.skillId) {
      return {
        success: false,
        message: 'æŠ±æ­‰ï¼Œæˆ‘æ— æ³•ç†è§£æ‚¨çš„è¯·æ±‚ã€‚è¯·å°è¯•æè¿°å¾—æ›´å…·ä½“ä¸€äº›ã€‚'
      };
    }

    // 3. è·å– Skill
    const skill = skillRegistry.get(intent.skillId);
    if (!skill) {
      return {
        success: false,
        message: `æœªæ‰¾åˆ°æŠ€èƒ½: ${intent.skillId}`
      };
    }

    // 4. å‚æ•°éªŒè¯
    const validation = skill.validate(intent.parameters);
    if (!validation.valid) {
      return {
        success: false,
        message: `å‚æ•°é”™è¯¯: ${validation.errors.join('; ')}`
      };
    }

    // 5. æ‰§è¡Œ Skill
    try {
      const result = await skill.execute(intent.parameters);

      if (result.success) {
        return {
          success: true,
          message: this.generateSuccessMessage(intent, result.data),
          data: result.data,
          skillId: intent.skillId
        };
      } else {
        return {
          success: false,
          message: `å¤„ç†å¤±è´¥: ${result.error}`
        };
      }
    } catch (error) {
      return {
        success: false,
        message: `æ‰§è¡Œé”™è¯¯: ${error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'}`
      };
    }
  }

  // ç›´æ¥è°ƒç”¨ Skillï¼ˆä¸ç»è¿‡æ„å›¾è¯†åˆ«ï¼‰
  async invoke(skillId: string, params: Record<string, any>): Promise<AgentResponse> {
    const skill = skillRegistry.get(skillId);
    if (!skill) {
      return {
        success: false,
        message: `æœªæ‰¾åˆ°æŠ€èƒ½: ${skillId}`
      };
    }

    const validation = skill.validate(params);
    if (!validation.valid) {
      return {
        success: false,
        message: `å‚æ•°é”™è¯¯: ${validation.errors.join('; ')}`
      };
    }

    try {
      const result = await skill.execute(params);
      return {
        success: result.success,
        message: result.success ? 'å¤„ç†å®Œæˆ' : `å¤„ç†å¤±è´¥: ${result.error}`,
        data: result.data,
        skillId
      };
    } catch (error) {
      return {
        success: false,
        message: `æ‰§è¡Œé”™è¯¯: ${error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'}`
      };
    }
  }

  // ç”ŸæˆæˆåŠŸæ¶ˆæ¯
  private generateSuccessMessage(intent: Intent, data: any): string {
    const { skillId } = intent;

    switch (skillId) {
      case 'image-expand':
        return `âœ… å›¾ç‰‡å·²æˆåŠŸæ‰©å±•ï¼\n\n` +
          `ğŸ“ åŸå§‹å°ºå¯¸: ${data.originalWidth} Ã— ${data.originalHeight}\n` +
          `ğŸ“ ç›®æ ‡å°ºå¯¸: ${data.targetWidth} Ã— ${data.targetHeight}\n` +
          `ğŸ¨ å¡«å……æ¨¡å¼: ${this.getModeDisplayName(data.mode)}`;

      default:
        return 'âœ… å¤„ç†å®Œæˆï¼';
    }
  }

  private getModeDisplayName(mode: string): string {
    const names: Record<string, string> = {
      'fill': 'å¡«å……ï¼ˆå¡«æ»¡æ•´ä¸ªåŒºåŸŸï¼‰',
      'fit': 'é€‚åº”ï¼ˆä¿æŒæ¯”ä¾‹ï¼Œç•™ç™½ï¼‰',
      'stretch': 'æ‹‰ä¼¸ï¼ˆå¡«æ»¡ï¼Œå¯èƒ½å˜å½¢ï¼‰'
    };
    return names[mode] || mode;
  }
}
```

---

### ç¬¬å››æ­¥ï¼šé›†æˆåˆ° UIï¼ˆUI å±‚ï¼‰

#### 4.1 åœ¨åº”ç”¨å¯åŠ¨æ—¶æ³¨å†Œ Skills

**æ–‡ä»¶ä½ç½®**: `src/main.tsx` æˆ– `src/App.tsx`

```typescript
import { registerSkills } from './skills';

// åœ¨åº”ç”¨å¯åŠ¨æ—¶æ³¨å†Œæ‰€æœ‰ Skills
registerSkills();

// ... å…¶ä»–åˆå§‹åŒ–ä»£ç 
```

#### 4.2 åˆ›å»ºå·¥å…·é¢æ¿

**æ–‡ä»¶ä½ç½®**: `src/chat/components/panels/MoreToolsPanel.tsx`

```typescript
import React from 'react';
import { X, Image } from 'lucide-react';

const tools = [
  {
    id: 'expand-image',
    icon: Image,
    label: 'å›¾ç‰‡æ‰©å±•',
    description: 'æ‰©å±•å›¾ç‰‡å°ºå¯¸',
    color: 'text-purple-500'
  },
  // ... å…¶ä»–å·¥å…·
];

export const MoreToolsPanel: React.FC<MoreToolsPanelProps> = ({ onClose, onAction }) => {
  return (
    <div className="bg-white rounded-2xl shadow-xl p-4">
      <h3 className="font-medium text-gray-800 mb-3">æ›´å¤šå·¥å…·</h3>

      <div className="grid grid-cols-2 gap-2">
        {tools.map(tool => (
          <button
            key={tool.id}
            onClick={() => { onAction(tool.id); onClose(); }}
            className="flex items-start gap-3 p-3 bg-gray-50 hover:bg-gray-100 rounded-xl"
          >
            <tool.icon className={`w-5 h-5 ${tool.color}`} />
            <div>
              <div className="font-medium text-sm">{tool.label}</div>
              <div className="text-xs text-gray-400">{tool.description}</div>
            </div>
          </button>
        ))}
      </div>
    </div>
  );
};
```

#### 4.3 åˆ›å»ºå‚æ•°é…ç½®å¯¹è¯æ¡†

**æ–‡ä»¶ä½ç½®**: `src/chat/components/dialogs/ExpandImageDialog.tsx`

```typescript
import React, { useState } from 'react';
import { Agent } from '../../../agent/agent';

export const ExpandImageDialog: React.FC<Props> = ({ imageUrl, onClose, onComplete }) => {
  const [targetWidth, setTargetWidth] = useState(1920);
  const [targetHeight, setTargetHeight] = useState(1080);
  const [mode, setMode] = useState<'fill' | 'fit' | 'stretch'>('fill');

  const handleExpand = async () => {
    const agent = new Agent();

    const result = await agent.invoke('image-expand', {
      imageUrl,
      targetWidth,
      targetHeight,
      mode
    });

    if (result.success) {
      onComplete(result.data);
    } else {
      alert(result.message);
    }
  };

  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center">
      <div className="bg-white rounded-2xl p-6 max-w-lg">
        <h2 className="text-lg font-semibold mb-4">å›¾ç‰‡å°ºå¯¸æ‰©å±•</h2>

        {/* å°ºå¯¸é€‰æ‹©å™¨ */}
        <div className="mb-4">
          <label>ç›®æ ‡å°ºå¯¸</label>
          <input type="number" value={targetWidth} onChange={e => setTargetWidth(+e.target.value)} />
          <span>Ã—</span>
          <input type="number" value={targetHeight} onChange={e => setTargetHeight(+e.target.value)} />
        </div>

        {/* æ¨¡å¼é€‰æ‹© */}
        <div className="mb-4">
          <label>å¡«å……æ¨¡å¼</label>
          <select value={mode} onChange={e => setMode(e.target.value as any)}>
            <option value="fill">å¡«å……</option>
            <option value="fit">é€‚åº”</option>
            <option value="stretch">æ‹‰ä¼¸</option>
          </select>
        </div>

        {/* æ“ä½œæŒ‰é’® */}
        <div className="flex gap-2">
          <button onClick={onClose}>å–æ¶ˆ</button>
          <button onClick={handleExpand}>æ‰§è¡Œæ‰©å±•</button>
        </div>
      </div>
    </div>
  );
};
```

#### 4.4 åœ¨ ChatView ä¸­é›†æˆ

**æ–‡ä»¶ä½ç½®**: `src/chat/ChatView.tsx`

```typescript
import { useState } from 'react';
import { Agent } from '../agent/agent';
import { ExpandImageDialog } from './components/dialogs/ExpandImageDialog';

export const ChatView = () => {
  const [showExpandDialog, setShowExpandDialog] = useState(false);
  const [selectedImage, setSelectedImage] = useState<string | null>(null);
  const agent = new Agent();

  // å¤„ç†å·¥å…·é¢æ¿çš„æ“ä½œ
  const handleToolAction = (actionId: string) => {
    if (actionId === 'expand-image') {
      setShowExpandDialog(true);
    }
  };

  // å¤„ç†æ‰©å±•å®Œæˆ
  const handleExpandComplete = (result: any) => {
    console.log('æ‰©å±•å®Œæˆ:', result);
    // å°†ç»“æœæ·»åŠ åˆ°æ¶ˆæ¯åˆ—è¡¨
    setShowExpandDialog(false);
  };

  // å¤„ç†ç”¨æˆ·è‡ªç„¶è¯­è¨€è¾“å…¥
  const handleUserInput = async (input: string) => {
    const response = await agent.chat(input);
    console.log('Agent å“åº”:', response);
  };

  return (
    <div>
      {/* ... å…¶ä»– UI */}

      <MoreToolsPanel onAction={handleToolAction} />

      {showExpandDialog && (
        <ExpandImageDialog
          imageUrl={selectedImage!}
          onClose={() => setShowExpandDialog(false)}
          onComplete={handleExpandComplete}
        />
      )}
    </div>
  );
};
```

---

## ğŸš€ æ·»åŠ æ–° Skill çš„å®Œæ•´æ­¥éª¤

### ç¤ºä¾‹ï¼šæ·»åŠ "å›¾ç‰‡è£å‰ª"åŠŸèƒ½

#### Step 1: å®šä¹‰å‚æ•°ç±»å‹

```typescript
// src/skills/base/types.ts
export interface CropImageParams extends ImageProcessingParams {
  x: number;
  y: number;
  width: number;
  height: number;
}

export interface CropImageResult {
  imageUrl: string;
  originalWidth: number;
  originalHeight: number;
  cropX: number;
  cropY: number;
  cropWidth: number;
  cropHeight: number;
}
```

#### Step 2: å®ç° Skill ç±»

```typescript
// src/skills/image/cropImage.ts
import { BaseSkill } from '../base/skill';
import { CropImageParams, CropImageResult } from '../base/types';

export class CropImageSkill extends BaseSkill {
  manifest = {
    id: 'image-crop',
    name: 'å›¾ç‰‡è£å‰ª',
    description: 'è£å‰ªå›¾ç‰‡çš„æŒ‡å®šåŒºåŸŸ',
    version: '1.0.0',
    parameters: {
      type: 'object' as const,
      properties: {
        imageUrl: { type: 'string', description: 'å›¾ç‰‡ URL' },
        x: { type: 'number', description: 'è£å‰ªèµ·å§‹ X åæ ‡' },
        y: { type: 'number', description: 'è£å‰ªèµ·å§‹ Y åæ ‡' },
        width: { type: 'number', description: 'è£å‰ªå®½åº¦' },
        height: { type: 'number', description: 'è£å‰ªé«˜åº¦' }
      },
      required: ['imageUrl', 'x', 'y', 'width', 'height']
    }
  };

  async execute(params: CropImageParams): Promise<SkillResult> {
    try {
      const { imageUrl, x, y, width, height } = params;

      // 1. åŠ è½½å›¾ç‰‡
      const img = await this.loadImage(imageUrl);

      // 2. åˆ›å»º Canvas
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d')!;
      canvas.width = width;
      canvas.height = height;

      // 3. è£å‰ªå›¾ç‰‡
      ctx.drawImage(img, x, y, width, height, 0, 0, width, height);

      // 4. å¯¼å‡ºç»“æœ
      const resultUrl = canvas.toDataURL('image/png');

      return this.createSuccessResult({
        imageUrl: resultUrl,
        originalWidth: img.width,
        originalHeight: img.height,
        cropX: x,
        cropY: y,
        cropWidth: width,
        cropHeight: height
      });
    } catch (error) {
      return this.createErrorResult(error instanceof Error ? error.message : 'è£å‰ªå¤±è´¥');
    }
  }

  private loadImage(src: string): Promise<HTMLImageElement> {
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.crossOrigin = 'anonymous';
      img.onload = () => resolve(img);
      img.onerror = () => reject(new Error('å›¾ç‰‡åŠ è½½å¤±è´¥'));
      img.src = src;
    });
  }
}
```

#### Step 3: æ³¨å†Œåˆ° MCP

```typescript
// src/skills/index.ts
import { CropImageSkill } from './image/cropImage';

export function registerSkills(): void {
  skillRegistry.register(new ExpandImageSkill());
  skillRegistry.register(new CropImageSkill());  // â† æ–°å¢
}
```

#### Step 4: æ·»åŠ æ„å›¾è¯†åˆ«è§„åˆ™

```typescript
// src/agent/intentRecognizer.ts
const SKILL_PATTERNS: Record<string, RegExp[]> = {
  'image-expand': [/* ... */],
  'image-crop': [    // â† æ–°å¢
    /è£å‰ª.*å›¾ç‰‡/i,
    /å‰ªåˆ‡.*åŒºåŸŸ/i,
    /crop.*image/i,
  ]
};
```

#### Step 5: æ·»åŠ  UI å…¥å£

```typescript
// src/chat/components/panels/MoreToolsPanel.tsx
const tools = [
  { id: 'expand-image', /* ... */ },
  {
    id: 'crop-image',  // â† æ–°å¢
    icon: Crop,
    label: 'å›¾ç‰‡è£å‰ª',
    description: 'è£å‰ªå›¾ç‰‡åŒºåŸŸ',
    color: 'text-green-500'
  },
];
```

#### Step 6: åˆ›å»ºé…ç½®å¯¹è¯æ¡†

```typescript
// src/chat/components/dialogs/CropImageDialog.tsx
export const CropImageDialog: React.FC<Props> = ({ imageUrl, onClose, onComplete }) => {
  // ... å®ç°è£å‰ªåŒºåŸŸé€‰æ‹© UI
};
```

---

## ğŸ“Š ç›®å½•ç»“æ„æ€»è§ˆ

```
thinkos-chat/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ agent/                      # Agent å±‚
â”‚   â”‚   â”œâ”€â”€ types.ts                # Agent ç±»å‹å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ intentRecognizer.ts     # æ„å›¾è¯†åˆ«å™¨
â”‚   â”‚   â””â”€â”€ agent.ts                # Agent æ ¸å¿ƒ
â”‚   â”‚
â”‚   â”œâ”€â”€ mcp/                        # MCP åè®®å±‚
â”‚   â”‚   â”œâ”€â”€ types.ts                # MCP ç±»å‹å®šä¹‰
â”‚   â”‚   â””â”€â”€ registry.ts             # Skill æ³¨å†Œè¡¨
â”‚   â”‚
â”‚   â”œâ”€â”€ skills/                     # Skills å®ç°å±‚
â”‚   â”‚   â”œâ”€â”€ base/
â”‚   â”‚   â”‚   â”œâ”€â”€ types.ts            # åŸºç¡€ç±»å‹
â”‚   â”‚   â”‚   â””â”€â”€ skill.ts            # BaseSkill åŸºç±»
â”‚   â”‚   â”œâ”€â”€ image/
â”‚   â”‚   â”‚   â”œâ”€â”€ expandImage.ts      # å›¾ç‰‡æ‰©å±•
â”‚   â”‚   â”‚   â”œâ”€â”€ cropImage.ts        # å›¾ç‰‡è£å‰ª
â”‚   â”‚   â”‚   â”œâ”€â”€ resizeImage.ts      # å›¾ç‰‡ç¼©æ”¾
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”œâ”€â”€ text/
â”‚   â”‚   â”‚   â”œâ”€â”€ translate.ts        # æ–‡æœ¬ç¿»è¯‘
â”‚   â”‚   â”‚   â”œâ”€â”€ summarize.ts        # æ–‡æœ¬æ‘˜è¦
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â””â”€â”€ index.ts                # ç»Ÿä¸€æ³¨å†Œå…¥å£
â”‚   â”‚
â”‚   â”œâ”€â”€ chat/                       # UI å±‚
â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”‚   â”œâ”€â”€ panels/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ MoreToolsPanel.tsx
â”‚   â”‚   â”‚   â””â”€â”€ dialogs/
â”‚   â”‚   â”‚       â”œâ”€â”€ ExpandImageDialog.tsx
â”‚   â”‚   â”‚       â””â”€â”€ CropImageDialog.tsx
â”‚   â”‚   â””â”€â”€ ChatView.tsx
â”‚   â”‚
â”‚   â””â”€â”€ utils/                      # å·¥å…·å±‚
â”‚       â””â”€â”€ logger.ts               # æ—¥å¿—å·¥å…·
â”‚
â””â”€â”€ docs/                           # æ–‡æ¡£
    â”œâ”€â”€ PRODUCT_REQUIREMENT.md      # æœ¬æ–‡æ¡£
    â”œâ”€â”€ agents/
    â”‚   â””â”€â”€ README.md
    â””â”€â”€ skills/
        â”œâ”€â”€ README.md
        â””â”€â”€ image-expand.md
```

---

## âœ… å½“å‰é¡¹ç›®çŠ¶æ€

### å·²å®Œæˆ âœ“
- [x] Skills åŸºç¡€æ¶æ„ï¼ˆBaseSkillã€ç±»å‹å®šä¹‰ï¼‰
- [x] MCP æ³¨å†Œè¡¨å®ç°
- [x] Agent æ ¸å¿ƒå’Œæ„å›¾è¯†åˆ«å™¨
- [x] å›¾ç‰‡æ‰©å±• Skill å®Œæ•´å®ç°
- [x] UI ç»„ä»¶ï¼ˆMoreToolsPanelã€ExpandImageDialogï¼‰
- [x] æ—¥å¿—å·¥å…·
- [x] æ–‡æ¡£ç»“æ„

### éœ€è¦å®Œå–„ âš 
- [ ] å°† `utils/logger.ts` ç§»åŠ¨åˆ° `src/utils/logger.ts`
- [ ] åœ¨ `src/main.tsx` ä¸­è°ƒç”¨ `registerSkills()` åˆå§‹åŒ–
- [ ] å®Œå–„ ChatView ä¸ Agent çš„é›†æˆ
- [ ] æ·»åŠ æ›´å¤š Skillsï¼ˆè£å‰ªã€ç¼©æ”¾ã€æ»¤é•œç­‰ï¼‰
- [ ] æ·»åŠ é”™è¯¯å¤„ç†å’Œç”¨æˆ·åé¦ˆ
- [ ] æ·»åŠ  Skill æ‰§è¡Œè¿›åº¦æ˜¾ç¤º
- [ ] æ·»åŠ å•å…ƒæµ‹è¯•

---

## ğŸ“ å…³é”®è®¾è®¡åŸåˆ™

### 1. å•ä¸€èŒè´£åŸåˆ™
- **Skills å±‚**ï¼šåªè´Ÿè´£å…·ä½“åŠŸèƒ½çš„å®ç°
- **MCP å±‚**ï¼šåªè´Ÿè´£ Skill çš„æ³¨å†Œå’Œç®¡ç†
- **Agent å±‚**ï¼šåªè´Ÿè´£æ„å›¾è¯†åˆ«å’Œè°ƒåº¦
- **UI å±‚**ï¼šåªè´Ÿè´£ç”¨æˆ·äº¤äº’

### 2. å¼€æ”¾å°é—­åŸåˆ™
- æ–°å¢ Skill ä¸éœ€è¦ä¿®æ”¹ç°æœ‰ä»£ç 
- ç»§æ‰¿ `BaseSkill` å³å¯å®ç°æ–°åŠŸèƒ½
- é€šè¿‡æ³¨å†Œè¡¨åŠ¨æ€ç®¡ç† Skills

### 3. æ¥å£éš”ç¦»åŸåˆ™
- `SkillManifest` å®šä¹‰äº† Skill çš„å…ƒæ•°æ®
- `execute()` å®šä¹‰äº†æ‰§è¡Œæ¥å£
- `validate()` å®šä¹‰äº†éªŒè¯æ¥å£

### 4. ä¾èµ–å€’ç½®åŸåˆ™
- Agent ä¾èµ– Skill æ¥å£ï¼Œè€Œä¸æ˜¯å…·ä½“å®ç°
- é€šè¿‡ MCP æ³¨å†Œè¡¨è§£è€¦ Agent å’Œ Skills

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [MCP (Model Context Protocol) è§„èŒƒ](https://modelcontextprotocol.io)
- [Agent è®¾è®¡æ¨¡å¼](https://www.patterns.dev/posts/agent-pattern)
- [React æœ€ä½³å®è·µ](https://react.dev)

---

## ğŸ¤ è´¡çŒ®æŒ‡å—

æ·»åŠ æ–° Skill æ—¶ï¼Œè¯·ç¡®ä¿ï¼š

1. **å®Œæ•´çš„ç±»å‹å®šä¹‰**ï¼šåœ¨ `types.ts` ä¸­å®šä¹‰å‚æ•°å’Œç»“æœç±»å‹
2. **ç»§æ‰¿ BaseSkill**ï¼šåˆ©ç”¨åŸºç±»çš„å‚æ•°éªŒè¯åŠŸèƒ½
3. **è¯¦ç»†çš„æ–‡æ¡£**ï¼šåœ¨ `docs/skills/` ä¸‹æ·»åŠ è¯´æ˜æ–‡æ¡£
4. **æ„å›¾è¯†åˆ«è§„åˆ™**ï¼šåœ¨ `intentRecognizer.ts` ä¸­æ·»åŠ åŒ¹é…æ¨¡å¼
5. **UI å…¥å£**ï¼šåœ¨ `MoreToolsPanel` ä¸­æ·»åŠ å·¥å…·å…¥å£
6. **é”™è¯¯å¤„ç†**ï¼šå¦¥å–„å¤„ç†æ‰€æœ‰å¯èƒ½çš„é”™è¯¯æƒ…å†µ
7. **æ—¥å¿—è®°å½•**ï¼šä½¿ç”¨ `log` å·¥å…·è®°å½•å…³é”®æ“ä½œ

---

**æœ€åæ›´æ–°**: 2026-01-12
**æ–‡æ¡£ç‰ˆæœ¬**: 1.0.0
